<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Byldr Engine - Perfect Grid</title>
    <style>
        :root {
            --accent: #007aff;
            --glass: rgba(255, 255, 255, 0.85);
            --border: rgba(255, 255, 255, 0.3);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #1a1a1a; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
        }
        
        #overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, #333 0%, #1a1a1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.6s ease, visibility 0.6s;
        }

        #startBtn {
            padding: 18px 54px;
            font-size: 18px;
            font-weight: 700;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 122, 255, 0.3);
        }

        #ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            border-radius: 20px;
            pointer-events: auto;
        }

        .stats-container {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 1.5px;
            color: #1c1c1e;
            text-transform: uppercase;
        }

        #toolbar {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px;
        }

        .preview-circle {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            border: 3px solid white;
            cursor: pointer;
        }

        .dropdown-menu {
            position: absolute;
            right: 75px;
            top: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px;
            display: none;
            width: 100px;
        }
        .dropdown-menu.open { display: grid; }

        .swatch {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 140px;
            height: 140px;
            pointer-events: auto;
            display: none;
        }

        .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: difference;
        }

        .btn-side {
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: rgba(0,0,0,0.06);
            border-radius: 18px;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="font-size: 50px; margin: 0; font-weight: 900;">BYLDR<span style="color:var(--accent)">.</span></h1>
        <p style="color: #8e8e93; margin-bottom: 30px;">Kostky p≈ôesnƒõ do ƒçtverc≈Ø</p>
        <button id="startBtn">START</button>
    </div>

    <div id="ui">
        <div class="glass-panel stats-container">
            STUDIO: <span id="obj-count" style="color:var(--accent)">0 KOSTEK</span>
        </div>

        <div class="center-dot"></div>
        <div id="joystick-zone"></div>

        <div id="toolbar" class="glass-panel">
            <div style="position: relative;">
                <div id="color-preview" class="preview-circle" style="background-color: #ff3b30;"></div>
                <div id="color-menu" class="glass-panel dropdown-menu">
                    <div class="swatch" style="background:#ff3b30" data-color="0xff3b30"></div>
                    <div class="swatch" style="background:#007aff" data-color="0x007aff"></div>
                    <div class="swatch" style="background:#34c759" data-color="0x34c759"></div>
                    <div class="swatch" style="background:#ffcc00" data-color="0xffcc00"></div>
                    <div class="swatch" style="background:#ffffff" data-color="0xffffff"></div>
                    <div class="swatch" style="background:#1c1c1e" data-color="0x1c1c1e"></div>
                </div>
            </div>
            <hr style="width: 100%; border: 0; border-top: 1px solid rgba(0,0,0,0.1); margin: 4px 0;">
            <button id="undo-btn" class="btn-side">‚Ü©</button>
            <button id="clear-btn" class="btn-side">üóëÔ∏è</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>

    <script>
        // MODUL 1.0 = JEDEN ƒåTVEREC M≈ò√ç≈ΩKY
        const GRID_SIZE = 1.0; 
        const BRICK_H = 0.6; // Poloviƒçn√≠ v√Ω≈°ka pro lep≈°√≠ vrstven√≠
        const PLAYER_H = 1.8;
        
        let scene, camera, renderer, ghost, raycaster;
        let bricks = [];
        let activeColor = 0xff3b30;
        let moveVec = { x: 0, y: 0 };
        let keys = {};
        let pitch = 0, yaw = 0;
        let isTouch = false;

        function createBrickMesh(color, isGhost = false) {
            const group = new THREE.Group();
            
            // Tƒõlo - m√≠rnƒõ men≈°√≠ ne≈æ m≈ô√≠≈æka, aby byly vidƒõt sp√°ry
            const geo = new THREE.BoxGeometry(GRID_SIZE * 0.96, BRICK_H, GRID_SIZE * 0.96);
            const mat = isGhost 
                ? new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.4 })
                : new THREE.MeshStandardMaterial({ color: color, roughness: 0.2, metalness: 0.1 });
            
            const body = new THREE.Mesh(geo, mat);
            group.add(body);

            // ≈†punt
            const sGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.15, 12);
            const stud = new THREE.Mesh(sGeo, mat);
            stud.position.y = BRICK_H / 2 + 0.075;
            group.add(stud);

            return group;
        }

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(5, PLAYER_H, 5);
            camera.rotation.order = 'YXZ';

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.HemisphereLight(0xffffff, 0x888888, 1));
            const light = new THREE.DirectionalLight(0xffffff, 0.5);
            light.position.set(10, 20, 10);
            light.castShadow = true;
            scene.add(light);

            // PODLAHA
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(200, 200),
                new THREE.MeshStandardMaterial({ color: 0xdddddd })
            );
            floor.rotation.x = -Math.PI / 2;
            floor.name = "GROUND";
            floor.receiveShadow = true;
            scene.add(floor);

            // M≈ò√ç≈ΩKA - Mus√≠ p≈ôesnƒõ sedƒõt na GRID_SIZE
            const grid = new THREE.GridHelper(200, 200 / GRID_SIZE, 0xaaaaaa, 0xcccccc);
            grid.position.y = 0.01;
            scene.add(grid);

            ghost = createBrickMesh(activeColor, true);
            scene.add(ghost);

            raycaster = new THREE.Raycaster();
            
            setupEvents();
            animate();
        }

        function setupEvents() {
            document.getElementById('color-preview').onclick = (e) => {
                e.stopPropagation();
                document.getElementById('color-menu').classList.toggle('open');
            };

            document.querySelectorAll('.swatch').forEach(s => {
                s.onclick = () => {
                    activeColor = parseInt(s.dataset.color);
                    document.getElementById('color-preview').style.backgroundColor = s.style.background;
                    scene.remove(ghost);
                    ghost = createBrickMesh(activeColor, true);
                    scene.add(ghost);
                    document.getElementById('color-menu').classList.remove('open');
                };
            });

            document.getElementById('undo-btn').onclick = () => {
                if(bricks.length > 0) scene.remove(bricks.pop());
                updateUI();
            };

            document.getElementById('clear-btn').onclick = () => {
                bricks.forEach(b => scene.remove(b));
                bricks = [];
                updateUI();
            };

            // Ovl√°d√°n√≠
            window.addEventListener('keydown', e => keys[e.code] = true);
            window.addEventListener('keyup', e => keys[e.code] = false);

            renderer.domElement.addEventListener('mousedown', () => {
                if(!isTouch && document.pointerLockElement !== renderer.domElement) {
                    renderer.domElement.requestPointerLock();
                } else if(!isTouch) {
                    placeBrick();
                }
            });

            window.addEventListener('mousemove', e => {
                if (document.pointerLockElement === renderer.domElement) {
                    yaw -= e.movementX * 0.002;
                    pitch -= e.movementY * 0.002;
                    pitch = Math.max(-1.5, Math.min(1.5, pitch));
                    camera.rotation.set(pitch, yaw, 0, 'YXZ');
                }
            });

            // Touch
            const jz = document.getElementById('joystick-zone');
            window.addEventListener('touchstart', e => {
                if(!isTouch) {
                    isTouch = true;
                    jz.style.display = 'block';
                    nipplejs.create({ zone: jz, mode: 'static', position: {left:'70px', bottom:'70px'}, size: 100 })
                        .on('move', (ev, d) => moveVec = d.vector).on('end', () => moveVec = {x:0, y:0});
                }
            });
        }

        function placeBrick() {
            if(!ghost.visible) return;
            const b = createBrickMesh(activeColor);
            b.position.copy(ghost.position);
            b.castShadow = true;
            b.receiveShadow = true;
            b.name = "BRICK";
            scene.add(b);
            bricks.push(b);
            updateUI();
        }

        function updateUI() {
            document.getElementById('obj-count').innerText = bricks.length + " KOSTEK";
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const speed = 0.15;
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir); dir.y = 0; dir.normalize();
            const side = new THREE.Vector3().crossVectors(camera.up, dir).normalize();

            if (keys['KeyW']) camera.position.addScaledVector(dir, speed);
            if (keys['KeyS']) camera.position.addScaledVector(dir, -speed);
            if (keys['KeyA']) camera.position.addScaledVector(side, speed);
            if (keys['KeyD']) camera.position.addScaledVector(side, -speed);
            
            if(moveVec.x || moveVec.y) {
                camera.position.addScaledVector(dir, moveVec.y * speed);
                camera.position.addScaledVector(side, -moveVec.x * speed);
            }
            camera.position.y = PLAYER_H;

            // SNAP LOGIKA
            raycaster.setFromCamera({x: 0, y: 0}, camera);
            const hits = raycaster.intersectObjects(scene.children, true);
            let target = null;
            
            for(let h of hits) {
                let obj = h.object;
                while(obj.parent && obj.parent !== scene) obj = obj.parent;
                if(obj === ghost) continue;
                if(obj.name === "GROUND" || obj.name === "BRICK") { target = h; break; }
            }

            if(target) {
                ghost.visible = true;
                const norm = target.face.normal.clone().transformDirection(target.object.matrixWorld);
                const pos = target.point.clone().add(norm.multiplyScalar(0.1));
                
                // ROUND zajist√≠ skok p≈ôesnƒõ doprost≈ôed ƒçtverce m≈ô√≠≈æky
                ghost.position.set(
                    Math.round(pos.x / GRID_SIZE) * GRID_SIZE,
                    Math.floor(pos.y / BRICK_H) * BRICK_H + (BRICK_H / 2),
                    Math.round(pos.z / GRID_SIZE) * GRID_SIZE
                );
                
                if(target.object.name === "GROUND") ghost.position.y = BRICK_H / 2;
            } else {
                ghost.visible = false;
            }

            renderer.render(scene, camera);
        }

        window.onload = () => {
            document.getElementById('startBtn').onclick = () => {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('ui').style.display = 'block';
                init();
            };
        };
    </script>
</body>
</html>
